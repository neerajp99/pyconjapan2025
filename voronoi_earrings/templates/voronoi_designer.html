<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3D Voronoi Flower Earring Designer</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .controls-panel {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        height: fit-content;
      }

      .controls-panel h2 {
        color: #4a5568;
        margin-bottom: 20px;
        font-size: 1.4em;
      }

      .control-group {
        margin-bottom: 20px;
      }

      .control-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2d3748;
      }

      .control-group select,
      .control-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      .control-group select:focus,
      .control-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .slider-container {
        position: relative;
      }

      .slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #e2e8f0;
        outline: none;
        -webkit-appearance: none;
      }

      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #667eea;
        cursor: pointer;
      }

      .slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #667eea;
        cursor: pointer;
        border: none;
      }

      .slider-value {
        position: absolute;
        right: 0;
        top: -25px;
        background: #4a5568;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
      }

      .generate-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease;
        margin-bottom: 15px;
      }

      .generate-btn:hover {
        transform: translateY(-2px);
      }

      .generate-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .export-btn {
        width: 100%;
        padding: 12px;
        background: #48bb78;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .export-btn:hover {
        background: #38a169;
      }

      .export-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .preview-panel {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .preview-panel h2 {
        color: #4a5568;
        margin-bottom: 20px;
        font-size: 1.4em;
      }

      .preview-container {
        width: 100%;
        height: 500px;
        border: 2px dashed #e2e8f0;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f7fafc;
        position: relative;
        overflow: hidden;
      }

      .preview-placeholder {
        text-align: center;
        color: #a0aec0;
      }

      .preview-placeholder i {
        font-size: 4em;
        margin-bottom: 15px;
        display: block;
      }

      .canvas-container {
        width: 100%;
        height: 100%;
        display: none;
      }

      #preview-canvas {
        width: 100%;
        height: 100%;
        border-radius: 8px;
      }

      .loading {
        display: none;
        text-align: center;
        color: #667eea;
      }

      .loading i {
        font-size: 2em;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .stats-panel {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-top: 20px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }

      .stat-item {
        text-align: center;
        padding: 15px;
        background: #f7fafc;
        border-radius: 8px;
      }

      .stat-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #667eea;
      }

      .stat-label {
        font-size: 0.9em;
        color: #718096;
        margin-top: 5px;
      }

      .error-message {
        background: #fed7d7;
        color: #c53030;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        display: none;
      }

      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2em;
        }
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-gem"></i> 3D Voronoi Flower Earring Designer</h1>
        <p>
          Create beautiful organic earring designs based on Roni Kaufman's
          Voronoi flowers algorithm
        </p>
      </div>

      <div class="main-content">
        <div class="controls-panel">
          <h2><i class="fas fa-sliders-h"></i> Design Controls</h2>

          <div class="control-group">
            <label for="size-select">Earring Size</label>
            <select id="size-select">
              <option value="small">Small (15×20mm)</option>
              <option value="medium" selected>Medium (20×25mm)</option>
              <option value="large">Large (25×30mm)</option>
            </select>
          </div>

          <div class="control-group">
            <label for="flowers-slider">Number of Flowers</label>
            <div class="slider-container">
              <input
                type="range"
                id="flowers-slider"
                class="slider"
                min="8"
                max="30"
                value="18"
              />
              <span class="slider-value" id="flowers-value">18</span>
            </div>
          </div>

          <div class="control-group">
            <label for="petals-slider">Petals per Flower</label>
            <div class="slider-container">
              <input
                type="range"
                id="petals-slider"
                class="slider"
                min="6"
                max="20"
                value="12"
              />
              <span class="slider-value" id="petals-value">12</span>
            </div>
          </div>

          <div class="control-group">
            <label for="material-select">3D Printing Material</label>
            <select id="material-select">
              <option value="PLA" selected>PLA (Easy printing)</option>
              <option value="PETG">PETG (Durable)</option>
              <option value="Resin">Resin (High detail)</option>
            </select>
          </div>

          <button class="generate-btn" id="generate-btn">
            <i class="fas fa-magic"></i> Generate Design
          </button>

          <button class="export-btn" id="export-btn" disabled>
            <i class="fas fa-download"></i> Export STL
          </button>

          <div class="error-message" id="error-message"></div>
        </div>

        <div class="preview-panel">
          <h2><i class="fas fa-eye"></i> 3D Preview</h2>
          <div class="preview-container" id="preview-container">
            <div class="preview-placeholder" id="preview-placeholder">
              <i class="fas fa-cube"></i>
              <p>Click "Generate Design" to see your 3D earring</p>
            </div>
            <div class="loading" id="loading">
              <i class="fas fa-spinner"></i>
              <p>Generating your design...</p>
            </div>
            <div class="canvas-container" id="canvas-container">
              <canvas id="preview-canvas"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="stats-panel" id="stats-panel" style="display: none">
        <h2><i class="fas fa-chart-bar"></i> Design Statistics</h2>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="stat-vertices">-</div>
            <div class="stat-label">Vertices</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="stat-faces">-</div>
            <div class="stat-label">Faces</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="stat-flowers">-</div>
            <div class="stat-label">Flowers</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="stat-size">-</div>
            <div class="stat-label">Size (mm)</div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="../static/js/orbit-controls.js"></script>
    <script>
      let currentDesign = null;
      let scene, camera, renderer, controls;

      // Initialize slider value displays
      document
        .getElementById("flowers-slider")
        .addEventListener("input", function () {
          document.getElementById("flowers-value").textContent = this.value;
        });

      document
        .getElementById("petals-slider")
        .addEventListener("input", function () {
          document.getElementById("petals-value").textContent = this.value;
        });

      // Initialize 3D scene
      function init3DScene() {
        const canvas = document.getElementById("preview-canvas");
        const container = document.getElementById("canvas-container");

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf7fafc);

        camera = new THREE.PerspectiveCamera(
          75,
          container.clientWidth / container.clientHeight,
          0.1,
          1000
        );
        camera.position.set(30, 30, 30);

        renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // Add lights
        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(50, 50, 50);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        animate();
      }

      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }

      // Generate design
      document
        .getElementById("generate-btn")
        .addEventListener("click", async function () {
          console.log("Generate button clicked");

          const generateBtn = this;
          const exportBtn = document.getElementById("export-btn");
          const loading = document.getElementById("loading");
          const placeholder = document.getElementById("preview-placeholder");
          const errorMessage = document.getElementById("error-message");

          const size = document.getElementById("size-select").value;
          const nFlowers = parseInt(
            document.getElementById("flowers-slider").value
          );
          const material = document.getElementById("material-select").value;

          console.log("Parameters:", { size, nFlowers, material });

          // Show loading state
          generateBtn.disabled = true;
          exportBtn.disabled = true;
          loading.style.display = "block";
          placeholder.style.display = "none";
          errorMessage.style.display = "none";

          try {
            const response = await fetch("/generate_earring", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                size: size,
                n_flowers: nFlowers,
                material: material,
              }),
            });

            console.log("Response status:", response.status);

            const result = await response.json();
            console.log("Response data:", result);

            if (result.success) {
              currentDesign = result.design;
              displayDesign(currentDesign);
              updateStats(currentDesign);
              exportBtn.disabled = false;
            } else {
              console.error("Server error:", result.error);
              throw new Error(result.error);
            }
          } catch (error) {
            console.error("Request error:", error);
            errorMessage.textContent =
              "Error generating design: " + error.message;
            errorMessage.style.display = "block";
            placeholder.style.display = "block";
          } finally {
            loading.style.display = "none";
            generateBtn.disabled = false;
          }
        });

      // Display 3D design
      function displayDesign(design) {
        console.log("Displaying design:", design);

        // Check if design has valid data
        if (!design || !design.vertices || !design.faces) {
          console.error("Invalid design data:", design);
          alert("Error: Invalid design data received");
          return;
        }

        if (design.vertices.length === 0 || design.faces.length === 0) {
          console.error(
            "Empty geometry:",
            design.vertices.length,
            "vertices,",
            design.faces.length,
            "faces"
          );
          alert("Error: No geometry data generated");
          return;
        }

        // Clear existing geometry
        while (scene.children.length > 0) {
          scene.remove(scene.children[0]);
        }

        // Add lights back
        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(50, 50, 50);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        // Create geometry from vertices and faces
        const geometry = new THREE.BufferGeometry();

        console.log(
          "Vertices:",
          design.vertices.length,
          "Faces:",
          design.faces.length
        );
        console.log("Sample vertex:", design.vertices[0]);
        console.log("Sample face:", design.faces[0]);

        // Convert vertices to Float32Array
        const vertices = [];
        for (let i = 0; i < design.vertices.length; i++) {
          vertices.push(
            design.vertices[i][0],
            design.vertices[i][1],
            design.vertices[i][2]
          );
        }
        const vertexArray = new Float32Array(vertices);

        // Convert faces to indices
        const indices = [];
        for (let i = 0; i < design.faces.length; i++) {
          indices.push(
            design.faces[i][0],
            design.faces[i][1],
            design.faces[i][2]
          );
        }
        const indexArray = new Uint32Array(indices);

        console.log(
          "Processed vertices:",
          vertexArray.length,
          "indices:",
          indexArray.length
        );
        console.log("First few vertices:", vertexArray.slice(0, 9));
        console.log("First few indices:", indexArray.slice(0, 9));

        geometry.setAttribute(
          "position",
          new THREE.BufferAttribute(vertexArray, 3)
        );
        geometry.setIndex(new THREE.BufferAttribute(indexArray, 1));
        geometry.computeVertexNormals();

        // Create material
        const material = new THREE.MeshLambertMaterial({
          color: 0xff6b9d,
          side: THREE.DoubleSide,
          wireframe: false,
        });

        // Create mesh
        const mesh = new THREE.Mesh(geometry, material);
        mesh.castShadow = true;
        mesh.receiveShadow = true;
        scene.add(mesh);

        console.log("Mesh added to scene:", mesh);

        // Center the camera on the object
        const box = new THREE.Box3().setFromObject(mesh);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());

        console.log("Bounding box center:", center, "size:", size);

        const maxDim = Math.max(size.x, size.y, size.z);
        const fov = camera.fov * (Math.PI / 180);
        let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
        cameraZ *= 2; // Add some padding

        camera.position.set(
          center.x + cameraZ,
          center.y + cameraZ,
          center.z + cameraZ
        );
        camera.lookAt(center);
        controls.target.copy(center);

        console.log("Camera positioned at:", camera.position);

        // Show canvas
        document.getElementById("canvas-container").style.display = "block";
        document.getElementById("stats-panel").style.display = "block";
      }

      // Update statistics
      function updateStats(design) {
        document.getElementById("stat-vertices").textContent =
          design.vertices.length;
        document.getElementById("stat-faces").textContent = design.faces.length;
        document.getElementById("stat-flowers").textContent =
          design.centroids.length;
        document.getElementById(
          "stat-size"
        ).textContent = `${design.size_config.width}×${design.size_config.height}`;
      }

      // Export STL
      document
        .getElementById("export-btn")
        .addEventListener("click", async function () {
          if (!currentDesign) return;

          try {
            const response = await fetch("/export_stl", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                vertices: currentDesign.vertices,
                faces: currentDesign.faces,
              }),
            });

            if (response.ok) {
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = response.headers
                .get("Content-Disposition")
                .split("filename=")[1];
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
            } else {
              throw new Error("Export failed");
            }
          } catch (error) {
            alert("Error exporting STL: " + error.message);
          }
        });

      // Handle window resize
      window.addEventListener("resize", function () {
        if (renderer && camera) {
          const container = document.getElementById("canvas-container");
          camera.aspect = container.clientWidth / container.clientHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(container.clientWidth, container.clientHeight);
        }
      });

      // Initialize 3D scene when page loads
      window.addEventListener("load", function () {
        init3DScene();
      });
    </script>
  </body>
</html>
